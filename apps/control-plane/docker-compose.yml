services:
  control-plane:
    build: .
    restart: unless-stopped
    environment:
      CONTROL_PLANE_DATABASE_URL: postgresql+psycopg://control_plane:${CONTROL_PLANE_DB_PASSWORD}@control-plane-db:5432/control_plane
      CONTROL_PLANE_ADMIN_TOKEN: ${CONTROL_PLANE_ADMIN_TOKEN}
      CONTROL_PLANE_JWT_SECRET: ${CONTROL_PLANE_JWT_SECRET}
      CONTROL_PLANE_GOOGLE_CLIENT_ID: ${CONTROL_PLANE_GOOGLE_CLIENT_ID}
      CONTROL_PLANE_GOOGLE_CLIENT_SECRET: ${CONTROL_PLANE_GOOGLE_CLIENT_SECRET}
      CONTROL_PLANE_STRIPE_SECRET_KEY: ${CONTROL_PLANE_STRIPE_SECRET_KEY}
      CONTROL_PLANE_STRIPE_WEBHOOK_SECRET: ${CONTROL_PLANE_STRIPE_WEBHOOK_SECRET}
      CONTROL_PLANE_STRIPE_PRICE_ID: ${CONTROL_PLANE_STRIPE_PRICE_ID}
      CONTROL_PLANE_DOCKER_HOST: unix:///var/run/docker.sock
      CONTROL_PLANE_IMAGE: ${CONTROL_PLANE_IMAGE}
      CONTROL_PLANE_ROOT_DOMAIN: ${CONTROL_PLANE_ROOT_DOMAIN}
      CONTROL_PLANE_PROXY_PROVIDER: ${CONTROL_PLANE_PROXY_PROVIDER}
      CONTROL_PLANE_PROXY_NETWORK: ${CONTROL_PLANE_PROXY_NETWORK}
      CONTROL_PLANE_CADDY_TLS: ${CONTROL_PLANE_CADDY_TLS}
      CONTROL_PLANE_PUBLIC_SITE_URL: ${CONTROL_PLANE_PUBLIC_SITE_URL}
      CONTROL_PLANE_INSTANCE_AUTH_DISABLED: ${CONTROL_PLANE_INSTANCE_AUTH_DISABLED}
      CONTROL_PLANE_INSTANCE_PASSWORD: ${CONTROL_PLANE_INSTANCE_PASSWORD}
      CONTROL_PLANE_INSTANCE_PASSWORD_HASH: ${CONTROL_PLANE_INSTANCE_PASSWORD_HASH}
      CONTROL_PLANE_INSTANCE_JWT_SECRET: ${CONTROL_PLANE_INSTANCE_JWT_SECRET}
      CONTROL_PLANE_INSTANCE_INTERNAL_API_SECRET: ${CONTROL_PLANE_INSTANCE_INTERNAL_API_SECRET}
      CONTROL_PLANE_INSTANCE_FERNET_SECRET: ${CONTROL_PLANE_INSTANCE_FERNET_SECRET}
      CONTROL_PLANE_INSTANCE_TRIGGER_SIGNING_SECRET: ${CONTROL_PLANE_INSTANCE_TRIGGER_SIGNING_SECRET}
      CONTROL_PLANE_INSTANCE_GOOGLE_CLIENT_ID: ${CONTROL_PLANE_INSTANCE_GOOGLE_CLIENT_ID}
      CONTROL_PLANE_INSTANCE_GOOGLE_CLIENT_SECRET: ${CONTROL_PLANE_INSTANCE_GOOGLE_CLIENT_SECRET}
    labels:
      # Caddy labels for control.longhouse.ai routing via coolify-proxy
      caddy: control.longhouse.ai
      caddy.reverse_proxy: "{{upstreams 8085}}"
      caddy.tls: internal
    ports:
      - "8085:8085"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/data/longhouse:/var/lib/docker/data/longhouse
    depends_on:
      - control-plane-db
    networks:
      - control-plane
      - coolify

  control-plane-db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: control_plane
      POSTGRES_USER: control_plane
      POSTGRES_PASSWORD: ${CONTROL_PLANE_DB_PASSWORD}
    volumes:
      - /var/lib/docker/data/longhouse-control-plane/postgres:/var/lib/postgresql/data
    networks:
      - control-plane

networks:
  control-plane:
    driver: bridge
  coolify:
    external: true
