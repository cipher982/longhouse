# Sauron - Standalone scheduler service
# Deployed to clifford VPS via Coolify
#
# This compose file is designed for Coolify deployment.
# Coolify sets --project-directory to repo root, so context is "."

networks:
  life-hub-shared:
    external: true

services:
  sauron:
    build:
      context: .  # Repo root (Coolify sets --project-directory here)
      dockerfile: apps/sauron/Dockerfile
    container_name: sauron
    restart: unless-stopped
    networks:
      - default
      - life-hub-shared

    # Allow container to reach host services (MongoDB, etc.)
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Volume for persistent data (jobs repo is in user home, not a volume)
    volumes:
      - sauron-data:/data

    # API port exposed only via Docker network (no public binding)
    # Jarvis accesses via Docker network name: sauron:8080
    expose:
      - "8080"

    environment:
      # === SSH key (base64 encoded) ===
      SSH_PRIVATE_KEY_B64: ${SSH_PRIVATE_KEY_B64}

      TZ: UTC

      # === Git sync for sauron-jobs repo ===
      JOBS_GIT_REPO_URL: ${JOBS_GIT_REPO_URL:-https://github.com/cipher982/sauron-jobs.git}
      JOBS_GIT_TOKEN: ${JOBS_GIT_TOKEN}
      JOBS_GIT_BRANCH: ${JOBS_GIT_BRANCH:-main}
      JOBS_DIR: /home/sauron/jobs
      JOBS_REFRESH_INTERVAL_SECONDS: ${JOBS_REFRESH_INTERVAL_SECONDS:-300}

      # === Database (job queue + ops.runs) ===
      # Same as life-hub DB - uses ops.* and jobs.* schemas
      DATABASE_URL: ${DATABASE_URL}
      JOB_QUEUE_ENABLED: "1"

      # === AWS SES (email) ===
      AWS_SES_ACCESS_KEY_ID: ${AWS_SES_ACCESS_KEY_ID}
      AWS_SES_SECRET_ACCESS_KEY: ${AWS_SES_SECRET_ACCESS_KEY}
      AWS_SES_REGION: ${AWS_SES_REGION:-us-east-1}

      # === Email addresses ===
      NOTIFY_EMAIL: ${NOTIFY_EMAIL:-david010@gmail.com}
      DIGEST_EMAIL: ${DIGEST_EMAIL:-david010@gmail.com}
      ALERT_EMAIL: ${ALERT_EMAIL:-david010@gmail.com}
      FROM_EMAIL: ${FROM_EMAIL:-Sauron <sauron@drose.io>}

      # === API settings ===
      API_HOST: "0.0.0.0"
      API_PORT: "8080"

      # === Logging ===
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

      # === Zerg config requirements ===
      # zerg.config validates these at runtime
      # OPENAI_API_KEY needed for jobs that call LLM APIs
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      # AUTH_DISABLED=1 to skip auth validation (we don't use auth in scheduler)
      AUTH_DISABLED: "1"
      # Skip weak secret validation
      JWT_SECRET: ${JWT_SECRET:-sauron-scheduler-secret-key}
      INTERNAL_API_SECRET: ${INTERNAL_API_SECRET:-sauron-internal-secret-key}
      # FERNET_SECRET needed for zerg.config validation
      FERNET_SECRET: ${FERNET_SECRET:-scheduler-fernet-placeholder}

      # === Job-specific env vars (passed through to jobs) ===
      # llm-benchmarks
      LLM_BENCH_MONGODB_URI: ${LLM_BENCH_MONGODB_URI}
      LLM_BENCH_OPENAI_API_KEY: ${LLM_BENCH_OPENAI_API_KEY}

      # Life-Hub API (for jobs that call life-hub endpoints)
      LIFE_HUB_API_URL: ${LIFE_HUB_API_URL:-https://data.drose.io}
      LIFE_HUB_API_KEY: ${LIFE_HUB_API_KEY}

      # GitHub (for worklog commits)
      GITHUB_TOKEN: ${GITHUB_TOKEN}

      # Google Ads
      GOOGLE_ADS_DEVELOPER_TOKEN: ${GOOGLE_ADS_DEVELOPER_TOKEN}
      GOOGLE_ADS_CLIENT_ID: ${GOOGLE_ADS_CLIENT_ID}
      GOOGLE_ADS_CLIENT_SECRET: ${GOOGLE_ADS_CLIENT_SECRET}
      GOOGLE_ADS_REFRESH_TOKEN: ${GOOGLE_ADS_REFRESH_TOKEN}
      GOOGLE_ADS_LOGIN_CUSTOMER_ID: ${GOOGLE_ADS_LOGIN_CUSTOMER_ID}

      # Crestwood camera
      CRESTWOOD_REFERENCE_PATH: ${CRESTWOOD_REFERENCE_PATH:-/data/crestwood/reference.jpg}
      CRESTWOOD_REFERENCE_URL: ${CRESTWOOD_REFERENCE_URL}

      # Traccar
      TRACCAR_STALE_THRESHOLD_MINUTES: ${TRACCAR_STALE_THRESHOLD_MINUTES:-1440}
      TRACCAR_ALERT_COOLDOWN_HOURS: ${TRACCAR_ALERT_COOLDOWN_HOURS:-24}

      # === sauron-jobs specific env vars ===
      # Jobs use LIFE_HUB_DB_URL (different name from DATABASE_URL)
      LIFE_HUB_DB_URL: ${LIFE_HUB_DB_URL}

      # AI Tools catalog (MinIO)
      AITOOLS_MINIO_ENDPOINT: ${AITOOLS_MINIO_ENDPOINT}
      AITOOLS_MINIO_ACCESS_KEY: ${AITOOLS_MINIO_ACCESS_KEY}
      AITOOLS_MINIO_SECRET_KEY: ${AITOOLS_MINIO_SECRET_KEY}
      AITOOLS_MINIO_BUCKET: ${AITOOLS_MINIO_BUCKET}
      AITOOLS_MINIO_SECURE: ${AITOOLS_MINIO_SECURE:-true}

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  sauron-data:
