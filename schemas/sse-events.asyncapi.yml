asyncapi: 3.0.0

info:
  title: Oikos SSE Event Protocol
  version: 1.0.0
  description: |
    Server-Sent Events (SSE) protocol for real-time updates from Oikos backend to frontend.
    Provides typed contracts for oikos execution, commis lifecycle, and tool monitoring.

    Features:
    - Strongly-typed event payloads
    - SSE envelope with event type, ID, and data
    - Common type schemas for consistency
    - Support for resumable streams via event IDs

defaultContentType: application/json

# ---------------------------------------------------------------------------
# Channels - SSE is server-to-client only (unidirectional)
# ---------------------------------------------------------------------------

channels:
  RunEventsChannel:
    address: /api/oikos/chat/stream
    description: Real-time oikos and commis events for a specific run
    messages:
      ConnectedEvent:
        $ref: '#/components/messages/ConnectedEvent'
      HeartbeatEvent:
        $ref: '#/components/messages/HeartbeatEvent'
      OikosStartedEvent:
        $ref: '#/components/messages/OikosStartedEvent'
      OikosThinkingEvent:
        $ref: '#/components/messages/OikosThinkingEvent'
      OikosTokenEvent:
        $ref: '#/components/messages/OikosTokenEvent'
      OikosCompleteEvent:
        $ref: '#/components/messages/OikosCompleteEvent'
      OikosDeferredEvent:
        $ref: '#/components/messages/OikosDeferredEvent'
      OikosWaitingEvent:
        $ref: '#/components/messages/OikosWaitingEvent'
      OikosResumedEvent:
        $ref: '#/components/messages/OikosResumedEvent'
      ErrorEvent:
        $ref: '#/components/messages/ErrorEvent'
      CommisSpawnedEvent:
        $ref: '#/components/messages/CommisSpawnedEvent'
      CommisStartedEvent:
        $ref: '#/components/messages/CommisStartedEvent'
      CommisCompleteEvent:
        $ref: '#/components/messages/CommisCompleteEvent'
      CommisSummaryReadyEvent:
        $ref: '#/components/messages/CommisSummaryReadyEvent'
      CommisToolStartedEvent:
        $ref: '#/components/messages/CommisToolStartedEvent'
      CommisToolCompletedEvent:
        $ref: '#/components/messages/CommisToolCompletedEvent'
      CommisToolFailedEvent:
        $ref: '#/components/messages/CommisToolFailedEvent'
      CommisOutputChunkEvent:
        $ref: '#/components/messages/CommisOutputChunkEvent'
      # Oikos tool monitoring (same treatment as commis tools)
      OikosToolStartedEvent:
        $ref: '#/components/messages/OikosToolStartedEvent'
      OikosToolProgressEvent:
        $ref: '#/components/messages/OikosToolProgressEvent'
      OikosToolCompletedEvent:
        $ref: '#/components/messages/OikosToolCompletedEvent'
      OikosToolFailedEvent:
        $ref: '#/components/messages/OikosToolFailedEvent'
      ShowSessionPickerEvent:
        $ref: '#/components/messages/ShowSessionPickerEvent'
      StreamControlEvent:
        $ref: '#/components/messages/StreamControlEvent'

# ---------------------------------------------------------------------------
# Operations - SSE is always server â†’ client (send only)
# ---------------------------------------------------------------------------

operations:
  StreamRunEvents:
    action: send
    channel:
      $ref: '#/channels/RunEventsChannel'
    summary: Stream oikos and commis events for a run

# ---------------------------------------------------------------------------
# Components - Messages and schemas
# ---------------------------------------------------------------------------

components:
  messages:
    # Connection lifecycle
    ConnectedEvent:
      name: connected
      summary: Initial connection confirmation (deprecated, use heartbeat)
      payload:
        $ref: '#/components/schemas/ConnectedPayload'
      x-sse-event-type: connected

    HeartbeatEvent:
      name: heartbeat
      summary: Keep-alive heartbeat (sent every 30s or on initial connect)
      payload:
        $ref: '#/components/schemas/HeartbeatPayload'
      x-sse-event-type: heartbeat

    # Oikos lifecycle
    OikosStartedEvent:
      name: oikos_started
      summary: Oikos began processing task
      payload:
        $ref: '#/components/schemas/OikosStartedPayload'
      x-sse-event-type: oikos_started

    OikosThinkingEvent:
      name: oikos_thinking
      summary: Oikos reasoning phase
      payload:
        $ref: '#/components/schemas/OikosThinkingPayload'
      x-sse-event-type: oikos_thinking

    OikosTokenEvent:
      name: oikos_token
      summary: LLM token stream (high frequency)
      payload:
        $ref: '#/components/schemas/OikosTokenPayload'
      x-sse-event-type: oikos_token

    OikosCompleteEvent:
      name: oikos_complete
      summary: Oikos finished successfully
      payload:
        $ref: '#/components/schemas/OikosCompletePayload'
      x-sse-event-type: oikos_complete

    OikosDeferredEvent:
      name: oikos_deferred
      summary: Timeout migration - oikos continues in background
      payload:
        $ref: '#/components/schemas/OikosDeferredPayload'
      x-sse-event-type: oikos_deferred

    OikosWaitingEvent:
      name: oikos_waiting
      summary: Oikos interrupted waiting for commis completion
      payload:
        $ref: '#/components/schemas/OikosWaitingPayload'
      x-sse-event-type: oikos_waiting

    OikosResumedEvent:
      name: oikos_resumed
      summary: Oikos resumed from interrupt after commis completion
      payload:
        $ref: '#/components/schemas/OikosResumedPayload'
      x-sse-event-type: oikos_resumed

    # Error handling
    ErrorEvent:
      name: error
      summary: Execution error occurred
      payload:
        $ref: '#/components/schemas/ErrorPayload'
      x-sse-event-type: error

    # Commis lifecycle
    CommisSpawnedEvent:
      name: commis_spawned
      summary: Commis job queued
      payload:
        $ref: '#/components/schemas/CommisSpawnedPayload'
      x-sse-event-type: commis_spawned

    CommisStartedEvent:
      name: commis_started
      summary: Commis execution began
      payload:
        $ref: '#/components/schemas/CommisStartedPayload'
      x-sse-event-type: commis_started

    CommisCompleteEvent:
      name: commis_complete
      summary: Commis finished (success or failure)
      payload:
        $ref: '#/components/schemas/CommisCompletePayload'
      x-sse-event-type: commis_complete

    CommisSummaryReadyEvent:
      name: commis_summary_ready
      summary: Commis summary extracted
      payload:
        $ref: '#/components/schemas/CommisSummaryReadyPayload'
      x-sse-event-type: commis_summary_ready

    # Commis tool monitoring
    CommisToolStartedEvent:
      name: commis_tool_started
      summary: Commis tool call began
      payload:
        $ref: '#/components/schemas/CommisToolStartedPayload'
      x-sse-event-type: commis_tool_started

    CommisToolCompletedEvent:
      name: commis_tool_completed
      summary: Commis tool call succeeded
      payload:
        $ref: '#/components/schemas/CommisToolCompletedPayload'
      x-sse-event-type: commis_tool_completed

    CommisToolFailedEvent:
      name: commis_tool_failed
      summary: Commis tool call failed
      payload:
        $ref: '#/components/schemas/CommisToolFailedPayload'
      x-sse-event-type: commis_tool_failed

    CommisOutputChunkEvent:
      name: commis_output_chunk
      summary: Live commis output chunk (ephemeral)
      payload:
        $ref: '#/components/schemas/CommisOutputChunkPayload'
      x-sse-event-type: commis_output_chunk

    # Oikos tool monitoring (uniform treatment with commis tools)
    OikosToolStartedEvent:
      name: oikos_tool_started
      summary: Oikos tool call began
      payload:
        $ref: '#/components/schemas/OikosToolStartedPayload'
      x-sse-event-type: oikos_tool_started

    OikosToolProgressEvent:
      name: oikos_tool_progress
      summary: Oikos tool progress update (streaming logs)
      payload:
        $ref: '#/components/schemas/OikosToolProgressPayload'
      x-sse-event-type: oikos_tool_progress

    OikosToolCompletedEvent:
      name: oikos_tool_completed
      summary: Oikos tool call succeeded
      payload:
        $ref: '#/components/schemas/OikosToolCompletedPayload'
      x-sse-event-type: oikos_tool_completed

    OikosToolFailedEvent:
      name: oikos_tool_failed
      summary: Oikos tool call failed
      payload:
        $ref: '#/components/schemas/OikosToolFailedPayload'
      x-sse-event-type: oikos_tool_failed

    ShowSessionPickerEvent:
      name: show_session_picker
      summary: Trigger session picker modal in frontend
      payload:
        $ref: '#/components/schemas/ShowSessionPickerPayload'
      x-sse-event-type: show_session_picker

    StreamControlEvent:
      name: stream_control
      summary: Explicit stream lifecycle control - keep_open extends lease, close is terminal
      payload:
        $ref: '#/components/schemas/StreamControlPayload'
      x-sse-event-type: stream_control

  schemas:
    # ---------------------------------------------------------------------------
    # SSE Envelope Structure
    # ---------------------------------------------------------------------------
    SSEEnvelope:
      type: object
      required: [event, data]
      additionalProperties: false
      properties:
        event:
          type: string
          description: SSE event type (maps to `event:` line)
          enum:
            - connected
            - heartbeat
            - oikos_started
            - oikos_thinking
            - oikos_token
            - oikos_complete
            - oikos_deferred
            - error
            - commis_spawned
            - commis_started
            - commis_complete
            - commis_summary_ready
            - commis_tool_started
            - commis_tool_completed
            - commis_tool_failed
            - commis_output_chunk
            - oikos_tool_started
            - oikos_tool_progress
            - oikos_tool_completed
            - oikos_tool_failed
            - show_session_picker
            - stream_control
        id:
          type: integer
          description: Event ID for resumption (maps to `id:` line in SSE protocol)
          minimum: 1
        data:
          type: object
          description: JSON payload (maps to `data:` line)

    # ---------------------------------------------------------------------------
    # Common Types
    # ---------------------------------------------------------------------------
    UsageData:
      type: object
      description: LLM token usage statistics
      properties:
        prompt_tokens:
          type: integer
          minimum: 0
        completion_tokens:
          type: integer
          minimum: 0
        total_tokens:
          type: integer
          minimum: 0
        reasoning_tokens:
          type: integer
          minimum: 0
          description: Reasoning tokens (OpenAI o1/o3 models)

    CommisStatus:
      type: string
      enum: [success, failed, cancelled, timeout]
      description: Commis execution result

    # ---------------------------------------------------------------------------
    # Connection Lifecycle Payloads
    # ---------------------------------------------------------------------------
    ConnectedPayload:
      type: object
      required: [message, run_id]
      properties:
        message:
          type: string
          description: Connection confirmation message
        run_id:
          type: integer
          minimum: 1
          description: Run ID for this SSE stream
        client_correlation_id:
          type: string
          description: Optional client-provided correlation ID

    HeartbeatPayload:
      type: object
      properties:
        message:
          type: string
          description: Optional heartbeat message
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp

    # ---------------------------------------------------------------------------
    # Oikos Event Payloads
    # ---------------------------------------------------------------------------
    OikosStartedPayload:
      type: object
      required: [task, thread_id, message_id]
      properties:
        run_id:
          type: integer
          minimum: 1
          description: Run ID (may be omitted in legacy events)
        thread_id:
          type: integer
          minimum: 1
          description: Thread ID for this conversation
        task:
          type: string
          minLength: 1
          description: User's task/question
        message_id:
          type: string
          format: uuid
          description: Unique identifier for the assistant message (stable across tokens/completion)
        continuation_of_message_id:
          type: string
          format: uuid
          description: For continuation runs, the message_id of the original run's message
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging (copy from UI for agent debugging)

    OikosThinkingPayload:
      type: object
      required: [message]
      properties:
        message:
          type: string
          minLength: 1
          description: Thinking status message
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    OikosTokenPayload:
      type: object
      required: [token]
      properties:
        token:
          type: string
          description: LLM token (may be empty string)
        run_id:
          type: integer
          minimum: 1
        thread_id:
          type: integer
          minimum: 1
        message_id:
          type: string
          format: uuid
          description: Unique identifier for the assistant message
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    OikosCompletePayload:
      type: object
      required: [result, status]
      properties:
        result:
          type: string
          description: Final oikos result
        status:
          type: string
          enum: [success, cancelled]
          description: Completion status ('success' for normal completion, 'cancelled' for user-initiated cancellation)
        duration_ms:
          type: integer
          minimum: 0
          description: Execution duration in milliseconds
        usage:
          $ref: '#/components/schemas/UsageData'
        run_id:
          type: integer
          minimum: 1
        fiche_id:
          type: integer
          minimum: 1
        thread_id:
          type: integer
          minimum: 1
        debug_url:
          type: string
          description: URL for debug/inspection
        message_id:
          type: string
          format: uuid
          description: Unique identifier for the assistant message
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    OikosDeferredPayload:
      type: object
      required: [message]
      properties:
        message:
          type: string
          minLength: 1
          description: Deferred status message
        attach_url:
          type: string
          description: URL to re-attach to the running execution
        timeout_seconds:
          type: number
          minimum: 0
          description: Timeout that triggered deferral
        run_id:
          type: integer
          minimum: 1
        fiche_id:
          type: integer
          minimum: 1
        thread_id:
          type: integer
          minimum: 1
        message_id:
          type: string
          format: uuid
          description: Unique identifier for the assistant message
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    OikosWaitingPayload:
      type: object
      required: [message]
      properties:
        message:
          type: string
          minLength: 1
          description: Waiting status message (e.g., commis spawned)
        job_id:
          type: integer
          minimum: 1
          description: Commis job ID (if applicable)
        close_stream:
          type: boolean
          description: If false, keep SSE stream open while waiting
        run_id:
          type: integer
          minimum: 1
        fiche_id:
          type: integer
          minimum: 1
        thread_id:
          type: integer
          minimum: 1
        message_id:
          type: string
          format: uuid
          description: Unique identifier for the assistant message
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    OikosResumedPayload:
      type: object
      required: [thread_id, message_id]
      properties:
        run_id:
          type: integer
          minimum: 1
        fiche_id:
          type: integer
          minimum: 1
        thread_id:
          type: integer
          minimum: 1
        message_id:
          type: string
          format: uuid
          description: Unique identifier for the assistant message
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    # ---------------------------------------------------------------------------
    # Error Payloads
    # ---------------------------------------------------------------------------
    ErrorPayload:
      type: object
      properties:
        error:
          type: string
          description: Error message
        message:
          type: string
          description: Alternative error message field
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    # ---------------------------------------------------------------------------
    # Commis Event Payloads
    # ---------------------------------------------------------------------------
    CommisSpawnedPayload:
      type: object
      required: [job_id, task]
      properties:
        job_id:
          type: integer
          minimum: 1
          description: Commis job ID
        tool_call_id:
          type: string
          description: Tool call ID for the spawn_commis invocation
        task:
          type: string
          minLength: 1
          description: Commis task (may be truncated to 100 chars)
        model:
          type: string
          description: LLM model for commis
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    CommisStartedPayload:
      type: object
      required: [job_id, commis_id]
      properties:
        job_id:
          type: integer
          minimum: 1
        commis_id:
          type: string
          minLength: 1
          description: Commis execution ID
        run_id:
          type: integer
          minimum: 1
        task:
          type: string
          description: Commis task (may be truncated)
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    CommisCompletePayload:
      type: object
      required: [job_id, status]
      properties:
        job_id:
          type: integer
          minimum: 1
        commis_id:
          type: string
          description: Commis execution ID
        status:
          $ref: '#/components/schemas/CommisStatus'
        duration_ms:
          type: integer
          minimum: 0
        error:
          type: string
          description: Error message (only present if status=failed)
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    CommisSummaryReadyPayload:
      type: object
      required: [job_id, summary]
      description: |
        Summary of a commis execution. For non-success, summary includes status prefix and error details.
      properties:
        job_id:
          type: integer
          minimum: 1
        commis_id:
          type: string
          description: Commis execution ID
        summary:
          type: string
          minLength: 1
          description: Extracted commis summary (includes [FAILED], [TIMEOUT], or [CANCELLED] prefix for non-success)
        status:
          $ref: '#/components/schemas/CommisStatus'
        error:
          type: string
          description: Error message if status is failed/timeout/cancelled (null for success)
          nullable: true
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    # ---------------------------------------------------------------------------
    # Commis Tool Monitoring Payloads
    # ---------------------------------------------------------------------------
    CommisToolStartedPayload:
      type: object
      required: [commis_id, tool_name, tool_call_id]
      properties:
        commis_id:
          type: string
          minLength: 1
        tool_name:
          type: string
          minLength: 1
        tool_call_id:
          type: string
          minLength: 1
          description: LangChain tool call ID
        tool_args_preview:
          type: string
          description: Preview of tool arguments (may be truncated)
        run_id:
          type: integer
          minimum: 1
          description: Required for security (prevents cross-run leakage)
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    CommisToolCompletedPayload:
      type: object
      required: [commis_id, tool_name, tool_call_id, duration_ms]
      properties:
        commis_id:
          type: string
          minLength: 1
        tool_name:
          type: string
          minLength: 1
        tool_call_id:
          type: string
          minLength: 1
        duration_ms:
          type: integer
          minimum: 0
        result_preview:
          type: string
          description: Preview of tool result (may be truncated)
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    CommisToolFailedPayload:
      type: object
      required: [commis_id, tool_name, tool_call_id, duration_ms, error]
      properties:
        commis_id:
          type: string
          minLength: 1
        tool_name:
          type: string
          minLength: 1
        tool_call_id:
          type: string
          minLength: 1
        duration_ms:
          type: integer
          minimum: 0
        error:
          type: string
          minLength: 1
          description: Error message
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    CommisOutputChunkPayload:
      type: object
      required: [commis_id, stream, data, run_id]
      properties:
        job_id:
          type: integer
          minimum: 1
          description: Commis job ID (spawn_commis job)
        commis_id:
          type: string
          minLength: 1
        runner_job_id:
          type: string
          minLength: 1
          description: Runner exec job UUID
        stream:
          type: string
          enum: [stdout, stderr]
          description: Output stream for this chunk
        data:
          type: string
          minLength: 1
          description: Output chunk (may be truncated)
        run_id:
          type: integer
          minimum: 1
          description: Required for security (prevents cross-run leakage)
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    # ---------------------------------------------------------------------------
    # Oikos Tool Monitoring Payloads
    # ---------------------------------------------------------------------------
    OikosToolStartedPayload:
      type: object
      required: [tool_name, tool_call_id]
      properties:
        tool_name:
          type: string
          minLength: 1
        tool_call_id:
          type: string
          minLength: 1
          description: Stable ID linking all events for this tool call
        tool_args_preview:
          type: string
          description: Preview of tool arguments (may be truncated)
        tool_args:
          type: object
          description: Full tool arguments (for persistence/raw view)
        run_id:
          type: integer
          minimum: 1
          description: Oikos run ID for correlation
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    OikosToolProgressPayload:
      type: object
      required: [tool_call_id, message]
      properties:
        tool_call_id:
          type: string
          minLength: 1
        message:
          type: string
          description: Progress message (log line)
        level:
          type: string
          enum: [debug, info, warn, error]
          description: Log level for styling
        progress_pct:
          type: integer
          minimum: 0
          maximum: 100
          description: Optional progress percentage
        data:
          type: object
          description: Optional structured data (metrics, artifacts preview)
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    OikosToolCompletedPayload:
      type: object
      required: [tool_name, tool_call_id, duration_ms]
      properties:
        tool_name:
          type: string
          minLength: 1
        tool_call_id:
          type: string
          minLength: 1
        duration_ms:
          type: integer
          minimum: 0
        result_preview:
          type: string
          description: Condensed result for collapsed view
        result:
          type: object
          description: Full result (for persistence/raw view)
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    OikosToolFailedPayload:
      type: object
      required: [tool_name, tool_call_id, duration_ms, error]
      properties:
        tool_name:
          type: string
          minLength: 1
        tool_call_id:
          type: string
          minLength: 1
        duration_ms:
          type: integer
          minimum: 0
        error:
          type: string
          minLength: 1
          description: Error message
        error_details:
          type: object
          description: Full error details (stack trace, context)
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    # ---------------------------------------------------------------------------
    # Session Picker Payloads
    # ---------------------------------------------------------------------------
    ShowSessionPickerPayload:
      type: object
      description: Trigger session picker modal in frontend
      properties:
        run_id:
          type: integer
          minimum: 1
          description: Current oikos run ID
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging
        filters:
          type: object
          description: Optional filters to pre-populate the picker
          properties:
            project:
              type: string
              description: Filter by project name
            query:
              type: string
              description: Search query text
            provider:
              type: string
              description: Filter by provider (claude, codex, gemini)

    # ---------------------------------------------------------------------------
    # Stream Control Payloads
    # ---------------------------------------------------------------------------
    StreamControlPayload:
      type: object
      required: [action, reason, run_id]
      description: Explicit stream lifecycle control - keep_open extends lease, close is terminal end-marker
      properties:
        action:
          type: string
          enum: [keep_open, close]
          description: keep_open extends stream lease; close is terminal end-marker
        reason:
          type: string
          description: Why this action (commiss_pending, continuation_start, all_complete, timeout, error)
        ttl_ms:
          type: integer
          minimum: 0
          maximum: 300000
          description: Lease time in ms (max 5 min); stream closes if no activity/renewal
        run_id:
          type: integer
          minimum: 1
          description: Run ID this control applies to
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging
        pending_commiss:
          type: integer
          minimum: 0
          description: Current pending commis count (for debugging)

# ---------------------------------------------------------------------------
# Extensions for code generation
# ---------------------------------------------------------------------------

x-sse-protocol:
  description: |
    Server-Sent Events use a text-based protocol with:
    - event: <type> - Event name (maps to message name)
    - id: <number> - Event ID for resumption
    - data: <json> - JSON payload
    - (empty line) - Event separator

x-security-notes:
  - All events include owner_id in backend but it's filtered before SSE emission
  - Tool events MUST include run_id to prevent cross-run leakage
  - SSE stream filters events by run_id and owner_id

x-performance-notes:
  - oikos_token events are high-frequency (per-token streaming)
  - Heartbeat sent every 30s to prevent timeout
  - Event IDs enable resumable streams (reconnect with Last-Event-ID header)
