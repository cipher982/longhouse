asyncapi: 3.0.0

info:
  title: Jarvis SSE Event Protocol
  version: 1.0.0
  description: |
    Server-Sent Events (SSE) protocol for real-time updates from Jarvis backend to frontend.
    Provides typed contracts for concierge execution, commis lifecycle, and tool monitoring.

    Features:
    - Strongly-typed event payloads
    - SSE envelope with event type, ID, and data
    - Common type schemas for consistency
    - Support for resumable streams via event IDs

defaultContentType: application/json

# ---------------------------------------------------------------------------
# Channels - SSE is server-to-client only (unidirectional)
# ---------------------------------------------------------------------------

channels:
  RunEventsChannel:
    address: /api/jarvis/chat/stream
    description: Real-time concierge and commis events for a specific run
    messages:
      ConnectedEvent:
        $ref: '#/components/messages/ConnectedEvent'
      HeartbeatEvent:
        $ref: '#/components/messages/HeartbeatEvent'
      ConciergeStartedEvent:
        $ref: '#/components/messages/ConciergeStartedEvent'
      ConciergeThinkingEvent:
        $ref: '#/components/messages/ConciergeThinkingEvent'
      ConciergeTokenEvent:
        $ref: '#/components/messages/ConciergeTokenEvent'
      ConciergeCompleteEvent:
        $ref: '#/components/messages/ConciergeCompleteEvent'
      ConciergeDeferredEvent:
        $ref: '#/components/messages/ConciergeDeferredEvent'
      ConciergeWaitingEvent:
        $ref: '#/components/messages/ConciergeWaitingEvent'
      ConciergeResumedEvent:
        $ref: '#/components/messages/ConciergeResumedEvent'
      ErrorEvent:
        $ref: '#/components/messages/ErrorEvent'
      CommisSpawnedEvent:
        $ref: '#/components/messages/CommisSpawnedEvent'
      CommisStartedEvent:
        $ref: '#/components/messages/CommisStartedEvent'
      CommisCompleteEvent:
        $ref: '#/components/messages/CommisCompleteEvent'
      CommisSummaryReadyEvent:
        $ref: '#/components/messages/CommisSummaryReadyEvent'
      CommisToolStartedEvent:
        $ref: '#/components/messages/CommisToolStartedEvent'
      CommisToolCompletedEvent:
        $ref: '#/components/messages/CommisToolCompletedEvent'
      CommisToolFailedEvent:
        $ref: '#/components/messages/CommisToolFailedEvent'
      # Concierge tool monitoring (same treatment as commis tools)
      ConciergeToolStartedEvent:
        $ref: '#/components/messages/ConciergeToolStartedEvent'
      ConciergeToolProgressEvent:
        $ref: '#/components/messages/ConciergeToolProgressEvent'
      ConciergeToolCompletedEvent:
        $ref: '#/components/messages/ConciergeToolCompletedEvent'
      ConciergeToolFailedEvent:
        $ref: '#/components/messages/ConciergeToolFailedEvent'

# ---------------------------------------------------------------------------
# Operations - SSE is always server â†’ client (send only)
# ---------------------------------------------------------------------------

operations:
  StreamRunEvents:
    action: send
    channel:
      $ref: '#/channels/RunEventsChannel'
    summary: Stream concierge and commis events for a run

# ---------------------------------------------------------------------------
# Components - Messages and schemas
# ---------------------------------------------------------------------------

components:
  messages:
    # Connection lifecycle
    ConnectedEvent:
      name: connected
      summary: Initial connection confirmation (deprecated, use heartbeat)
      payload:
        $ref: '#/components/schemas/ConnectedPayload'
      x-sse-event-type: connected

    HeartbeatEvent:
      name: heartbeat
      summary: Keep-alive heartbeat (sent every 30s or on initial connect)
      payload:
        $ref: '#/components/schemas/HeartbeatPayload'
      x-sse-event-type: heartbeat

    # Concierge lifecycle
    ConciergeStartedEvent:
      name: concierge_started
      summary: Concierge began processing task
      payload:
        $ref: '#/components/schemas/ConciergeStartedPayload'
      x-sse-event-type: concierge_started

    ConciergeThinkingEvent:
      name: concierge_thinking
      summary: Concierge reasoning phase
      payload:
        $ref: '#/components/schemas/ConciergeThinkingPayload'
      x-sse-event-type: concierge_thinking

    ConciergeTokenEvent:
      name: concierge_token
      summary: LLM token stream (high frequency)
      payload:
        $ref: '#/components/schemas/ConciergeTokenPayload'
      x-sse-event-type: concierge_token

    ConciergeCompleteEvent:
      name: concierge_complete
      summary: Concierge finished successfully
      payload:
        $ref: '#/components/schemas/ConciergeCompletePayload'
      x-sse-event-type: concierge_complete

    ConciergeDeferredEvent:
      name: concierge_deferred
      summary: Timeout migration - concierge continues in background
      payload:
        $ref: '#/components/schemas/ConciergeDeferredPayload'
      x-sse-event-type: concierge_deferred

    ConciergeWaitingEvent:
      name: concierge_waiting
      summary: Concierge interrupted waiting for commis completion
      payload:
        $ref: '#/components/schemas/ConciergeWaitingPayload'
      x-sse-event-type: concierge_waiting

    ConciergeResumedEvent:
      name: concierge_resumed
      summary: Concierge resumed from interrupt after commis completion
      payload:
        $ref: '#/components/schemas/ConciergeResumedPayload'
      x-sse-event-type: concierge_resumed

    # Error handling
    ErrorEvent:
      name: error
      summary: Execution error occurred
      payload:
        $ref: '#/components/schemas/ErrorPayload'
      x-sse-event-type: error

    # Commis lifecycle
    CommisSpawnedEvent:
      name: commis_spawned
      summary: Commis job queued
      payload:
        $ref: '#/components/schemas/CommisSpawnedPayload'
      x-sse-event-type: commis_spawned

    CommisStartedEvent:
      name: commis_started
      summary: Commis execution began
      payload:
        $ref: '#/components/schemas/CommisStartedPayload'
      x-sse-event-type: commis_started

    CommisCompleteEvent:
      name: commis_complete
      summary: Commis finished (success or failure)
      payload:
        $ref: '#/components/schemas/CommisCompletePayload'
      x-sse-event-type: commis_complete

    CommisSummaryReadyEvent:
      name: commis_summary_ready
      summary: Commis summary extracted
      payload:
        $ref: '#/components/schemas/CommisSummaryReadyPayload'
      x-sse-event-type: commis_summary_ready

    # Commis tool monitoring
    CommisToolStartedEvent:
      name: commis_tool_started
      summary: Commis tool call began
      payload:
        $ref: '#/components/schemas/CommisToolStartedPayload'
      x-sse-event-type: commis_tool_started

    CommisToolCompletedEvent:
      name: commis_tool_completed
      summary: Commis tool call succeeded
      payload:
        $ref: '#/components/schemas/CommisToolCompletedPayload'
      x-sse-event-type: commis_tool_completed

    CommisToolFailedEvent:
      name: commis_tool_failed
      summary: Commis tool call failed
      payload:
        $ref: '#/components/schemas/CommisToolFailedPayload'
      x-sse-event-type: commis_tool_failed

    # Concierge tool monitoring (uniform treatment with commis tools)
    ConciergeToolStartedEvent:
      name: concierge_tool_started
      summary: Concierge tool call began
      payload:
        $ref: '#/components/schemas/ConciergeToolStartedPayload'
      x-sse-event-type: concierge_tool_started

    ConciergeToolProgressEvent:
      name: concierge_tool_progress
      summary: Concierge tool progress update (streaming logs)
      payload:
        $ref: '#/components/schemas/ConciergeToolProgressPayload'
      x-sse-event-type: concierge_tool_progress

    ConciergeToolCompletedEvent:
      name: concierge_tool_completed
      summary: Concierge tool call succeeded
      payload:
        $ref: '#/components/schemas/ConciergeToolCompletedPayload'
      x-sse-event-type: concierge_tool_completed

    ConciergeToolFailedEvent:
      name: concierge_tool_failed
      summary: Concierge tool call failed
      payload:
        $ref: '#/components/schemas/ConciergeToolFailedPayload'
      x-sse-event-type: concierge_tool_failed

  schemas:
    # ---------------------------------------------------------------------------
    # SSE Envelope Structure
    # ---------------------------------------------------------------------------
    SSEEnvelope:
      type: object
      required: [event, data]
      additionalProperties: false
      properties:
        event:
          type: string
          description: SSE event type (maps to `event:` line)
          enum:
            - connected
            - heartbeat
            - concierge_started
            - concierge_thinking
            - concierge_token
            - concierge_complete
            - concierge_deferred
            - error
            - commis_spawned
            - commis_started
            - commis_complete
            - commis_summary_ready
            - commis_tool_started
            - commis_tool_completed
            - commis_tool_failed
            - concierge_tool_started
            - concierge_tool_progress
            - concierge_tool_completed
            - concierge_tool_failed
        id:
          type: integer
          description: Event ID for resumption (maps to `id:` line in SSE protocol)
          minimum: 1
        data:
          type: object
          description: JSON payload (maps to `data:` line)

    # ---------------------------------------------------------------------------
    # Common Types
    # ---------------------------------------------------------------------------
    UsageData:
      type: object
      description: LLM token usage statistics
      properties:
        prompt_tokens:
          type: integer
          minimum: 0
        completion_tokens:
          type: integer
          minimum: 0
        total_tokens:
          type: integer
          minimum: 0
        reasoning_tokens:
          type: integer
          minimum: 0
          description: Reasoning tokens (OpenAI o1/o3 models)

    CommisStatus:
      type: string
      enum: [success, failed]
      description: Commis execution result

    # ---------------------------------------------------------------------------
    # Connection Lifecycle Payloads
    # ---------------------------------------------------------------------------
    ConnectedPayload:
      type: object
      required: [message, run_id]
      properties:
        message:
          type: string
          description: Connection confirmation message
        run_id:
          type: integer
          minimum: 1
          description: Run ID for this SSE stream
        client_correlation_id:
          type: string
          description: Optional client-provided correlation ID

    HeartbeatPayload:
      type: object
      properties:
        message:
          type: string
          description: Optional heartbeat message
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp

    # ---------------------------------------------------------------------------
    # Concierge Event Payloads
    # ---------------------------------------------------------------------------
    ConciergeStartedPayload:
      type: object
      required: [task, thread_id, message_id]
      properties:
        run_id:
          type: integer
          minimum: 1
          description: Run ID (may be omitted in legacy events)
        thread_id:
          type: integer
          minimum: 1
          description: Thread ID for this conversation
        task:
          type: string
          minLength: 1
          description: User's task/question
        message_id:
          type: string
          format: uuid
          description: Unique identifier for the assistant message (stable across tokens/completion)
        continuation_of_message_id:
          type: string
          format: uuid
          description: For continuation runs, the message_id of the original run's message
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging (copy from UI for agent debugging)

    ConciergeThinkingPayload:
      type: object
      required: [message]
      properties:
        message:
          type: string
          minLength: 1
          description: Thinking status message
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    ConciergeTokenPayload:
      type: object
      required: [token]
      properties:
        token:
          type: string
          description: LLM token (may be empty string)
        run_id:
          type: integer
          minimum: 1
        thread_id:
          type: integer
          minimum: 1
        message_id:
          type: string
          format: uuid
          description: Unique identifier for the assistant message
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    ConciergeCompletePayload:
      type: object
      required: [result, status]
      properties:
        result:
          type: string
          description: Final concierge result
        status:
          type: string
          enum: [success, cancelled]
          description: Completion status ('success' for normal completion, 'cancelled' for user-initiated cancellation)
        duration_ms:
          type: integer
          minimum: 0
          description: Execution duration in milliseconds
        usage:
          $ref: '#/components/schemas/UsageData'
        run_id:
          type: integer
          minimum: 1
        agent_id:
          type: integer
          minimum: 1
        thread_id:
          type: integer
          minimum: 1
        debug_url:
          type: string
          description: URL for debug/inspection
        message_id:
          type: string
          format: uuid
          description: Unique identifier for the assistant message
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    ConciergeDeferredPayload:
      type: object
      required: [message]
      properties:
        message:
          type: string
          minLength: 1
          description: Deferred status message
        attach_url:
          type: string
          description: URL to re-attach to the running execution
        timeout_seconds:
          type: number
          minimum: 0
          description: Timeout that triggered deferral
        run_id:
          type: integer
          minimum: 1
        agent_id:
          type: integer
          minimum: 1
        thread_id:
          type: integer
          minimum: 1
        message_id:
          type: string
          format: uuid
          description: Unique identifier for the assistant message
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    ConciergeWaitingPayload:
      type: object
      required: [message]
      properties:
        message:
          type: string
          minLength: 1
          description: Waiting status message (e.g., commis spawned)
        job_id:
          type: integer
          minimum: 1
          description: Commis job ID (if applicable)
        close_stream:
          type: boolean
          description: If false, keep SSE stream open while waiting
        run_id:
          type: integer
          minimum: 1
        agent_id:
          type: integer
          minimum: 1
        thread_id:
          type: integer
          minimum: 1
        message_id:
          type: string
          format: uuid
          description: Unique identifier for the assistant message
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    ConciergeResumedPayload:
      type: object
      required: [thread_id, message_id]
      properties:
        run_id:
          type: integer
          minimum: 1
        agent_id:
          type: integer
          minimum: 1
        thread_id:
          type: integer
          minimum: 1
        message_id:
          type: string
          format: uuid
          description: Unique identifier for the assistant message
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    # ---------------------------------------------------------------------------
    # Error Payloads
    # ---------------------------------------------------------------------------
    ErrorPayload:
      type: object
      properties:
        error:
          type: string
          description: Error message
        message:
          type: string
          description: Alternative error message field
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    # ---------------------------------------------------------------------------
    # Commis Event Payloads
    # ---------------------------------------------------------------------------
    CommisSpawnedPayload:
      type: object
      required: [job_id, task]
      properties:
        job_id:
          type: integer
          minimum: 1
          description: Commis job ID
        tool_call_id:
          type: string
          description: Tool call ID for the spawn_commis invocation
        task:
          type: string
          minLength: 1
          description: Commis task (may be truncated to 100 chars)
        model:
          type: string
          description: LLM model for commis
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    CommisStartedPayload:
      type: object
      required: [job_id, commis_id]
      properties:
        job_id:
          type: integer
          minimum: 1
        commis_id:
          type: string
          minLength: 1
          description: Commis execution ID
        run_id:
          type: integer
          minimum: 1
        task:
          type: string
          description: Commis task (may be truncated)
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    CommisCompletePayload:
      type: object
      required: [job_id, status]
      properties:
        job_id:
          type: integer
          minimum: 1
        commis_id:
          type: string
          description: Commis execution ID
        status:
          $ref: '#/components/schemas/CommisStatus'
        duration_ms:
          type: integer
          minimum: 0
        error:
          type: string
          description: Error message (only present if status=failed)
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    CommisSummaryReadyPayload:
      type: object
      required: [job_id, summary]
      properties:
        job_id:
          type: integer
          minimum: 1
        commis_id:
          type: string
          description: Commis execution ID
        summary:
          type: string
          minLength: 1
          description: Extracted commis summary
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    # ---------------------------------------------------------------------------
    # Commis Tool Monitoring Payloads
    # ---------------------------------------------------------------------------
    CommisToolStartedPayload:
      type: object
      required: [commis_id, tool_name, tool_call_id]
      properties:
        commis_id:
          type: string
          minLength: 1
        tool_name:
          type: string
          minLength: 1
        tool_call_id:
          type: string
          minLength: 1
          description: LangChain tool call ID
        tool_args_preview:
          type: string
          description: Preview of tool arguments (may be truncated)
        run_id:
          type: integer
          minimum: 1
          description: Required for security (prevents cross-run leakage)
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    CommisToolCompletedPayload:
      type: object
      required: [commis_id, tool_name, tool_call_id, duration_ms]
      properties:
        commis_id:
          type: string
          minLength: 1
        tool_name:
          type: string
          minLength: 1
        tool_call_id:
          type: string
          minLength: 1
        duration_ms:
          type: integer
          minimum: 0
        result_preview:
          type: string
          description: Preview of tool result (may be truncated)
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    CommisToolFailedPayload:
      type: object
      required: [commis_id, tool_name, tool_call_id, duration_ms, error]
      properties:
        commis_id:
          type: string
          minLength: 1
        tool_name:
          type: string
          minLength: 1
        tool_call_id:
          type: string
          minLength: 1
        duration_ms:
          type: integer
          minimum: 0
        error:
          type: string
          minLength: 1
          description: Error message
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    # ---------------------------------------------------------------------------
    # Concierge Tool Monitoring Payloads
    # ---------------------------------------------------------------------------
    ConciergeToolStartedPayload:
      type: object
      required: [tool_name, tool_call_id]
      properties:
        tool_name:
          type: string
          minLength: 1
        tool_call_id:
          type: string
          minLength: 1
          description: Stable ID linking all events for this tool call
        tool_args_preview:
          type: string
          description: Preview of tool arguments (may be truncated)
        tool_args:
          type: object
          description: Full tool arguments (for persistence/raw view)
        run_id:
          type: integer
          minimum: 1
          description: Concierge run ID for correlation
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    ConciergeToolProgressPayload:
      type: object
      required: [tool_call_id, message]
      properties:
        tool_call_id:
          type: string
          minLength: 1
        message:
          type: string
          description: Progress message (log line)
        level:
          type: string
          enum: [debug, info, warn, error]
          description: Log level for styling
        progress_pct:
          type: integer
          minimum: 0
          maximum: 100
          description: Optional progress percentage
        data:
          type: object
          description: Optional structured data (metrics, artifacts preview)
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    ConciergeToolCompletedPayload:
      type: object
      required: [tool_name, tool_call_id, duration_ms]
      properties:
        tool_name:
          type: string
          minLength: 1
        tool_call_id:
          type: string
          minLength: 1
        duration_ms:
          type: integer
          minimum: 0
        result_preview:
          type: string
          description: Condensed result for collapsed view
        result:
          type: object
          description: Full result (for persistence/raw view)
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

    ConciergeToolFailedPayload:
      type: object
      required: [tool_name, tool_call_id, duration_ms, error]
      properties:
        tool_name:
          type: string
          minLength: 1
        tool_call_id:
          type: string
          minLength: 1
        duration_ms:
          type: integer
          minimum: 0
        error:
          type: string
          minLength: 1
          description: Error message
        error_details:
          type: object
          description: Full error details (stack trace, context)
        run_id:
          type: integer
          minimum: 1
        trace_id:
          type: string
          format: uuid
          description: End-to-end trace ID for debugging

# ---------------------------------------------------------------------------
# Extensions for code generation
# ---------------------------------------------------------------------------

x-sse-protocol:
  description: |
    Server-Sent Events use a text-based protocol with:
    - event: <type> - Event name (maps to message name)
    - id: <number> - Event ID for resumption
    - data: <json> - JSON payload
    - (empty line) - Event separator

x-security-notes:
  - All events include owner_id in backend but it's filtered before SSE emission
  - Tool events MUST include run_id to prevent cross-run leakage
  - SSE stream filters events by run_id and owner_id

x-performance-notes:
  - concierge_token events are high-frequency (per-token streaming)
  - Heartbeat sent every 30s to prevent timeout
  - Event IDs enable resumable streams (reconnect with Last-Event-ID header)
