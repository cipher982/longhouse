# Production Docker Compose - Frontend Only
# Deploys as separate Coolify app: zerg-web
#
# Single-domain architecture: frontend nginx proxies /api/* to backend.
# Set BACKEND_HOST to backend container name (e.g., zerg-backend for Coolify).
#
# For cross-origin (not recommended): Set API_BASE_URL and WS_BASE_URL env vars.
# Without these, frontend uses same-origin /api (nginx proxies to backend).
#
# Build-time args for analytics (set in Coolify as "Available at Build Time"):
#   VITE_UMAMI_WEBSITE_ID, VITE_UMAMI_SCRIPT_SRC, VITE_UMAMI_DOMAINS
#
# Use: docker compose -f docker/docker-compose.prod.frontend.yml up -d

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  zerg-frontend:
    build:
      context: .
      dockerfile: apps/zerg/frontend-web/Dockerfile
      target: production
      args:
        VITE_UMAMI_WEBSITE_ID: ${VITE_UMAMI_WEBSITE_ID}
        VITE_UMAMI_SCRIPT_SRC: ${VITE_UMAMI_SCRIPT_SRC}
        VITE_UMAMI_DOMAINS: ${VITE_UMAMI_DOMAINS}
    restart: unless-stopped
    # Note: No ports mapping - Coolify proxy handles external routing
    environment:
      # BACKEND_HOST: Docker hostname for nginx proxy (default: backend for docker-compose)
      BACKEND_HOST: ${BACKEND_HOST:-backend}
      # Optional: For cross-origin mode, set API_BASE_URL/WS_BASE_URL
      # Without these, frontend uses same-origin /api (nginx proxies to BACKEND_HOST)
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:80/ | grep -q 'Longhouse'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - coolify
    logging: *default-logging
    # Note: read_only omitted because entrypoint generates config.js at startup
    tmpfs:
      - /var/cache/nginx:noexec,nosuid,size=50m,uid=1000,gid=1000
      - /var/log/nginx:noexec,nosuid,size=10m,uid=1000,gid=1000
      - /var/run:noexec,nosuid,size=10m,uid=1000,gid=1000
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 64M
          cpus: '0.1'

networks:
  coolify:
    external: true
