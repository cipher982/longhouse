# Patrol Finding: edge_case

**Date:** 2026-01-28T12:17:55.147683
**Target:** apps/zerg/backend/zerg/jobs/commis.py
**Prompt:** edge_case

## Description

Initial lease extension failure in _run_job returns early without handling job state, leaving job in claimed limbo until natural lease expiration

## Evidence

- `apps/zerg/backend/zerg/jobs/commis.py:196-199`

## Test

```python
async def test_initial_lease_failure():
    """When initial extend_lease fails, job should be rescheduled or marked dead."""
    # Setup: Mock queue job in 'claimed' state
    queue_job = QueueJob(id='q1', job_id='test_job', attempts=0, max_attempts=3)
    owner = default_owner()

    # Mock: extend_lease returns False on first call
    with patch('zerg.jobs.commis.extend_lease', return_value=False):
        result = await run_queue_job('q1', owner)

    # Expected: Job should be marked dead or rescheduled, not left claimed
    # Actual: Job remains in 'claimed' state with no completion record
    # Verify: SELECT status FROM queue WHERE id = 'q1' should NOT be 'claimed'
```

## Suggested Fix

When initial lease extension fails, explicitly reschedule or mark the job as dead instead of silently returning:

if not await extend_lease(queue_job.id, owner, lease_seconds):
    logger.error("Lost lease before execution for %s (%s)", queue_job.job_id, queue_job.id)
    # Reschedule or mark dead instead of leaving in limbo
    if queue_job.attempts >= queue_job.max_attempts:
        await complete_job(queue_job.id, "dead", "Initial lease extension failed", owner=owner)
    else:
        retry_at = datetime.now(UTC) + timedelta(seconds=_retry_delay(queue_job.attempts))
        await reschedule_job(queue_job.id, retry_at, "Initial lease extension failed", owner=owner)
    return

---
*Generated by patrol/edge_case*
